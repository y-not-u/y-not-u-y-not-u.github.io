---
title: 网站迁移及环境配置那些事儿
date: 2016-07-06 12:00:00
tags: web,linux
---

## 原来的站点被DDos了

最初是放在韩国的kt上的，考虑到中国到韩国的速度较快，所以访问方面没有一点问题。

但昨天凌晨kt把机子关了，说遭到了DDos的攻击，峰值达到7.6G。虽然只是很小的流量，但服务器商就是关了，还说要关24h。重新开启之后，会换IP，要么买他家的抗D服务，10G100刀，真是抢钱了 。

网站流量虽然不大，但是还是有人随时访问的，宕机一天的损失也是挺大的。考虑到腊鸡kt说关就关还坑钱，毅然决定搬出来。

了解到ovh的机子都是无限量抗D，但是由于机房大多在加拿大那种十万八千里的地方，而我家客流大多是国内的，访问速度肯定惨不忍睹。

最后选到一家综合性价比不错，还带cn2的，可买抗D防护的，https://www.globalfrag.com。

另外毫无疑问的上了cloudflare的cdn。

速度是变慢了，但是保障多了。

## oneinstack的问题

本来的机子上是自己用yum装个lnmp。正好迁移图着简单配置，所以准备试试oneinstack的脚本。

实话说脚本的易用性还是可以的。

但尴尬的地方也来了。

* 一键脚本编译安装，官方连个比较正式点的文档都没，没说各个软件的配置文件的路径在哪，在安装结束时会打印一下，但是谁能一下记住。

* 网站需要用到fileinfo的扩展，我自己装的时候是自带的，发现用脚本居然没有编译进去。然后就是一晚上的安装这个插件。从需要安装pecl到，fileinfo需要和php版本对应，反正各种报错，我都要放弃了。之后发现，可以去下个php的源码，解压进去找到fileinfo进行编译安装。并在php.ini中加入扩展fileinfo.so。

  今早才发现oneinstack上有人和我遇到同样的问题（原文链接https://oneinstack.com/question/lnmp-why-fileinfo-extension/），官方解答说，考虑到编译这个时间较长，小鸡可能吃不消，所以没有默认编译进去，在oneinstack的文件夹里保留了安装的php版本的包。

## PHP的坑

之前的站点用的php7.0，本地开发环境也一样，当函数命名为new时没有问题，但当现在的环境换到5.6之后，开始报错了。一查发现这是PHP的保留词，好吧我孤陋寡闻了。看来7.0完善并使之成为了feature。

## 晚上又打了两波

峰值不高，就是死耗。

即使上了cloudflare的cdn，免费版也直接打出源IP，后来就不打域名，直接打IP了。

攻击有500G流量了。

人艰不拆，若无杀父之仇，还请手下留情。

## 7.8 更新

已找到打手，说对方花了150/天，打10天。

果然是友商的攻击。

后来把idcf的机子都打到删除账号了。
